import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Navbar } from '@/components/Navbar';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import { QuizQuestion, SessionFocusSummary, PerQuestionFocus } from '@/types/quiz';
import { Download, Home, CheckCircle, XCircle, Eye, Trophy, Target, Clock, BarChart3 } from 'lucide-react';
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  Legend,
} from 'recharts';
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';

interface EvaluationResultItem {
  question_number: number;
  score: number; // 0.0 - 1.0
}

interface QuizResult {
  score: number;
  totalPoints: number;
  percentage: number;
  focusTime: number;
  answers: Record<string, string | number>;
  questions: QuizQuestion[];
  startedAt?: string;
  completedAt?: string;
  evaluationResults?: EvaluationResultItem[];
  focusSummary?: SessionFocusSummary;
}

const Results = () => {
  const navigate = useNavigate();
  const [result, setResult] = useState<QuizResult | null>(null);

  useEffect(() => {
    const stored = localStorage.getItem('quiz_result');
    if (stored) {
      const parsed = JSON.parse(stored);
      setResult(parsed);
    }
  }, []);

  const handleDownloadPDF = () => {
    if (!result) return;

    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    let y = 20;

    // Title
    doc.setFontSize(22);
    doc.setFont('helvetica', 'bold');
    doc.text('Quiz Results Report', pageWidth / 2, y, { align: 'center' });
    y += 12;

    // Score summary
    doc.setFontSize(14);
    doc.text(`Overall Score: ${result.percentage}%`, pageWidth / 2, y, { align: 'center' });
    y += 8;
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    doc.text(`${result.score} out of ${result.totalPoints} points`, pageWidth / 2, y, { align: 'center' });
    y += 8;
    doc.text(`Focus Score: ${result.focusTime}%`, pageWidth / 2, y, { align: 'center' });
    y += 6;

    // Timeline
    if (result.startedAt || result.completedAt) {
      doc.text(
        `Started: ${result.startedAt ? new Date(result.startedAt).toLocaleString() : '—'}  |  Ended: ${result.completedAt ? new Date(result.completedAt).toLocaleString() : '—'}`,
        pageWidth / 2, y, { align: 'center' }
      );
      y += 6;
    }
    if (result.focusSummary) {
      doc.text(`Duration: ${Math.round(result.focusSummary.totalDurationMs / 1000)}s`, pageWidth / 2, y, { align: 'center' });
      y += 6;
    }

    y += 6;

    // Question breakdown table
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('Question Breakdown', 14, y);
    y += 4;

    const tableRows = result.questions.map((q, idx) => {
      const evalScore = result.evaluationResults?.find(r => r.question_number === parseInt(q.id));
      const scoreStr = evalScore ? `${Math.round(evalScore.score * 100)}%` : '—';
      const userAns = result.answers[q.id];
      let answerStr = '';
      if ((q.type === 'mcq' || q.type === 'bcq') && typeof userAns === 'number' && q.options) {
        answerStr = q.options[userAns] ?? '';
      } else if (typeof userAns === 'string') {
        answerStr = userAns.length > 80 ? userAns.substring(0, 80) + '...' : userAns;
      } else {
        answerStr = 'Not answered';
      }

      const qFocus = result.focusSummary?.perQuestion?.find(pq => pq.questionNumber === idx + 1);
      const focusStr = qFocus ? `${qFocus.averageFocusPercent}%` : '—';

      return [
        `Q${idx + 1}`,
        q.type.toUpperCase(),
        q.question.length > 60 ? q.question.substring(0, 60) + '...' : q.question,
        answerStr,
        scoreStr,
        focusStr,
      ];
    });

    autoTable(doc, {
      startY: y,
      head: [['#', 'Type', 'Question', 'Your Answer', 'Score', 'Focus']],
      body: tableRows,
      styles: { fontSize: 8, cellPadding: 2 },
      headStyles: { fillColor: [59, 130, 246] },
      columnStyles: {
        0: { cellWidth: 10 },
        1: { cellWidth: 16 },
        2: { cellWidth: 55 },
        3: { cellWidth: 55 },
        4: { cellWidth: 18 },
        5: { cellWidth: 16 },
      },
    });

    // Footer
    const finalY = (doc as any).lastAutoTable?.finalY ?? y + 40;
    doc.setFontSize(8);
    doc.setFont('helvetica', 'italic');
    doc.text('Generated by AI Quiz Platform', pageWidth / 2, finalY + 10, { align: 'center' });

    doc.save('quiz-results.pdf');
  };

  if (!result) {
    return (
      <div className="min-h-screen bg-background">
        <Navbar />
        <div className="container py-16 text-center">
          <h2 className="text-2xl font-bold mb-4">No results found</h2>
          <Button onClick={() => navigate('/dashboard')}>Back to Dashboard</Button>
        </div>
      </div>
    );
  }

  const getScoreColor = (percentage: number) => {
    if (percentage >= 80) return 'text-success';
    if (percentage >= 60) return 'text-warning';
    return 'text-destructive';
  };

  const getScoreMessage = (percentage: number) => {
    if (percentage >= 90) return 'Excellent!';
    if (percentage >= 80) return 'Great job!';
    if (percentage >= 60) return 'Good effort!';
    return 'Keep practicing!';
  };

  const getFocusColor = (percent: number) => {
    if (percent >= 80) return 'text-success';
    if (percent >= 60) return 'text-warning';
    return 'text-destructive';
  };

  // Get evaluation score for a question
  const getEvalScore = (questionId: string): number | null => {
    if (!result.evaluationResults) return null;
    const item = result.evaluationResults.find(r => r.question_number === parseInt(questionId));
    return item ? item.score : null;
  };

  // Get per-question focus data
  const getQuestionFocus = (questionNumber: number): PerQuestionFocus | null => {
    if (!result.focusSummary?.perQuestion) return null;
    return result.focusSummary.perQuestion.find(q => q.questionNumber === questionNumber) ?? null;
  };

  const focusSummary = result.focusSummary;

  return (
    <div className="min-h-screen bg-background">
      <Navbar />

      <main className="container py-8 max-w-4xl animate-fade-in">
        {/* Score Overview */}
        <Card className="mb-8 overflow-hidden">
          <div className="gradient-primary p-8 text-primary-foreground text-center">
            <Trophy className="h-12 w-12 mx-auto mb-4 opacity-90" />
            <p className="text-lg opacity-90 mb-2">{getScoreMessage(result.percentage)}</p>
            <h1 className={`text-6xl font-bold mb-2 ${getScoreColor(result.percentage)}`}>
              {result.percentage}%
            </h1>
            <p className="text-lg opacity-90">
              {result.score} out of {result.totalPoints} points
            </p>
          </div>
        </Card>

        {/* Stats Cards */}
        <div className="grid gap-4 md:grid-cols-3 mb-8">
          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-lg bg-success/10">
                  <Target className="h-6 w-6 text-success" />
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">Accuracy</p>
                  <p className="text-2xl font-bold">{result.percentage}%</p>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-lg bg-primary/10">
                  <CheckCircle className="h-6 w-6 text-primary" />
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">Questions</p>
                  <p className="text-2xl font-bold">{result.questions.length}</p>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-lg bg-accent/10">
                  <Eye className="h-6 w-6 text-accent" />
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">Focus Score</p>
                  <p className={`text-2xl font-bold ${getFocusColor(result.focusTime)}`}>{result.focusTime}%</p>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Quiz Timeline */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Clock className="h-5 w-5" />
              Quiz Timeline
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex flex-col sm:flex-row gap-4 text-sm text-muted-foreground">
              <div className="flex items-center gap-2">
                <span className="font-medium">Started:</span>
                <span>{result.startedAt ? new Date(result.startedAt).toLocaleString() : '—'}</span>
              </div>
              <div className="flex items-center gap-2">
                <span className="font-medium">Ended:</span>
                <span>{result.completedAt ? new Date(result.completedAt).toLocaleString() : '—'}</span>
              </div>
              {focusSummary && (
                <div className="flex items-center gap-2">
                  <span className="font-medium">Duration:</span>
                  <span>{Math.round(focusSummary.totalDurationMs / 1000)}s</span>
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        {/* Question Breakdown */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle>Question-wise Breakdown</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {result.questions.map((question, idx) => {
              const userAnswer = result.answers[question.id];
              const wasAnswered = userAnswer !== undefined;
              const evalScore = getEvalScore(question.id);
              const qFocus = getQuestionFocus(idx + 1);
              const scorePercent = evalScore !== null ? Math.round(evalScore * 100) : null;

              return (
                <div key={question.id} className="p-4 rounded-lg bg-muted/30 border">
                  <div className="flex items-start justify-between gap-4 mb-3">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <Badge variant={question.type === 'mcq' ? 'default' : question.type === 'bcq' ? 'outline' : 'secondary'}>
                          {question.type === 'mcq' ? 'MCQ' : question.type === 'bcq' ? 'True/False' : 'Subjective'}
                        </Badge>
                        <span className="text-sm text-muted-foreground">
                          {question.points} points
                        </span>
                        {scorePercent !== null && (
                          <Badge variant={scorePercent >= 80 ? 'default' : scorePercent >= 50 ? 'secondary' : 'destructive'}>
                            Score: {scorePercent}%
                          </Badge>
                        )}
                      </div>
                      <p className="font-medium">Q{idx + 1}. {question.question}</p>
                    </div>
                    {scorePercent !== null && (
                      <div className={`p-2 rounded-full ${scorePercent >= 50 ? 'bg-success/10' : 'bg-destructive/10'}`}>
                        {scorePercent >= 50 ? (
                          <CheckCircle className="h-5 w-5 text-success" />
                        ) : (
                          <XCircle className="h-5 w-5 text-destructive" />
                        )}
                      </div>
                    )}
                  </div>

                  {(question.type === 'mcq' || question.type === 'bcq') && question.options && (
                    <div className="grid gap-2 text-sm">
                      {question.options.map((opt, optIdx) => (
                        <div
                          key={optIdx}
                          className={`p-2 rounded ${
                            userAnswer === optIdx
                              ? scorePercent !== null && scorePercent >= 50
                                ? 'bg-success/10 text-success border border-success/30'
                                : 'bg-destructive/10 text-destructive border border-destructive/30'
                              : 'bg-background'
                          }`}
                        >
                          <span className="font-medium mr-2">
                            {question.type === 'bcq' ? (optIdx === 0 ? 'T.' : 'F.') : `${String.fromCharCode(65 + optIdx)}.`}
                          </span>
                          {opt}
                          {userAnswer === optIdx && (
                            scorePercent !== null && scorePercent >= 50
                              ? <CheckCircle className="inline h-4 w-4 ml-2" />
                              : <XCircle className="inline h-4 w-4 ml-2" />
                          )}
                        </div>
                      ))}
                    </div>
                  )}

                  {question.type === 'subjective' && (
                    <div className="mt-2 p-3 bg-background rounded border">
                      <p className="text-sm text-muted-foreground mb-1">Your Answer:</p>
                      <p className="text-sm">
                        {wasAnswered ? (userAnswer as string) : <em className="text-muted-foreground">Not answered</em>}
                      </p>
                    </div>
                  )}

                  {/* Per-question focus data */}
                  {qFocus && (
                    <div className="mt-3 p-2 bg-muted/20 rounded flex flex-wrap gap-4 text-xs text-muted-foreground">
                      <span>Focus: <strong className={getFocusColor(qFocus.averageFocusPercent)}>{qFocus.averageFocusPercent}%</strong></span>
                      <span>Time: <strong>{(qFocus.timeSpentMs / 1000).toFixed(1)}s</strong></span>
                      <span>Gaze deviation: <strong>{qFocus.gazeDeviationAvg.toFixed(3)}</strong></span>
                      <span>Status: <strong>{qFocus.focusStatus}</strong></span>
                    </div>
                  )}
                </div>
              );
            })}
          </CardContent>
        </Card>

        {/* Focus Statistics */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Eye className="h-5 w-5" />
              Focus Statistics
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div>
                <div className="flex justify-between mb-2">
                  <span className="text-sm text-muted-foreground">Overall Focus Score</span>
                  <span className={`font-medium ${getFocusColor(result.focusTime)}`}>{result.focusTime}%</span>
                </div>
                <Progress value={result.focusTime} className="h-3" />
              </div>
              {focusSummary && (
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <p className="text-muted-foreground">Total Duration</p>
                    <p className="font-medium">{Math.round(focusSummary.totalDurationMs / 1000)}s</p>
                  </div>
                  <div>
                    <p className="text-muted-foreground">Focused Time</p>
                    <p className="font-medium">{Math.round(focusSummary.totalFocusedTimeMs / 1000)}s</p>
                  </div>
                </div>
              )}
              <p className="text-sm text-muted-foreground">
                Focus data is captured via eye gaze tracking using your camera during the quiz.
              </p>
            </div>
          </CardContent>
        </Card>

        {/* Charts Section */}
        {(result.evaluationResults && result.evaluationResults.length > 0) && (() => {
          // Build chart data
          const chartData = result.questions.map((q, idx) => {
            const evalScore = getEvalScore(q.id);
            const qFocus = getQuestionFocus(idx + 1);
            return {
              name: `Q${idx + 1}`,
              score: evalScore !== null ? Math.round(evalScore * 100) : 0,
              focus: qFocus ? Math.round(qFocus.averageFocusPercent) : 0,
              time: qFocus ? Math.round(qFocus.timeSpentMs / 1000) : 0,
            };
          });

          return (
            <div className="space-y-8 mb-8">
              {/* Score Breakdown Chart */}
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <BarChart3 className="h-5 w-5" />
                    Score Breakdown
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <ResponsiveContainer width="100%" height={300}>
                    <BarChart data={chartData}>
                      <CartesianGrid strokeDasharray="3 3" opacity={0.3} />
                      <XAxis dataKey="name" />
                      <YAxis domain={[0, 100]} tickFormatter={(v) => `${v}%`} />
                      <Tooltip formatter={(value: number) => [`${value}%`, 'Score']} />
                      <Bar dataKey="score" fill="hsl(var(--primary))" radius={[4, 4, 0, 0]} />
                    </BarChart>
                  </ResponsiveContainer>
                </CardContent>
              </Card>

              {/* Focus vs Score Comparison */}
              {focusSummary && focusSummary.perQuestion.length > 0 && (
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <Eye className="h-5 w-5" />
                      Focus vs Score Comparison
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <ResponsiveContainer width="100%" height={300}>
                      <BarChart data={chartData}>
                        <CartesianGrid strokeDasharray="3 3" opacity={0.3} />
                        <XAxis dataKey="name" />
                        <YAxis domain={[0, 100]} tickFormatter={(v) => `${v}%`} />
                        <Tooltip formatter={(value: number, name: string) => [`${value}%`, name === 'score' ? 'Score' : 'Focus']} />
                        <Legend />
                        <Bar dataKey="score" fill="hsl(var(--primary))" name="Score %" radius={[4, 4, 0, 0]} />
                        <Bar dataKey="focus" fill="hsl(142, 76%, 36%)" name="Focus %" radius={[4, 4, 0, 0]} />
                      </BarChart>
                    </ResponsiveContainer>
                  </CardContent>
                </Card>
              )}

              {/* Time Spent Per Question */}
              {focusSummary && focusSummary.perQuestion.length > 0 && (
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <Clock className="h-5 w-5" />
                      Time Spent Per Question
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <ResponsiveContainer width="100%" height={300}>
                      <BarChart data={chartData}>
                        <CartesianGrid strokeDasharray="3 3" opacity={0.3} />
                        <XAxis dataKey="name" />
                        <YAxis tickFormatter={(v) => `${v}s`} />
                        <Tooltip formatter={(value: number) => [`${value}s`, 'Time']} />
                        <Bar dataKey="time" fill="hsl(262, 83%, 58%)" name="Seconds" radius={[4, 4, 0, 0]} />
                      </BarChart>
                    </ResponsiveContainer>
                  </CardContent>
                </Card>
              )}
            </div>
          );
        })()}

        {/* Actions */}
        <div className="flex flex-wrap gap-4 justify-center">
          <Button variant="gradient" size="lg" onClick={handleDownloadPDF} className="gap-2">
            <Download className="h-5 w-5" />
            Download Report as PDF
          </Button>
          <Button variant="outline" size="lg" onClick={() => navigate('/dashboard')} className="gap-2">
            <Home className="h-5 w-5" />
            Back to Dashboard
          </Button>
        </div>
      </main>
    </div>
  );
};

export default Results;
